<!-- templates/yourapp/admin_dashboard.html -->
{% extends 'base.html' %}
{% load static %}
    {% block head %}
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --bs-body-bg-color: #f8f9fa;
            --bs-content-bg-color: #ffffff;
            --bs-border-color: #dee2e6;
        }
        .content-wrapper {
            padding: 1.5rem;
        }
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #6c757d;
        }
        .kpi-card .kpi-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        .kpi-card .kpi-value {
            font-size: 2rem;
            font-weight: 600;
        }
        .kpi-trend {
            font-size: 0.85rem;
            font-weight: 600;
            min-height: 1.2em; /* Prevent layout shift */
        }
        .kpi-trend .fa-arrow-up { color: #198754; }
        .kpi-trend .fa-arrow-down { color: #dc3545; }

        #liveRecords tbody, #secEvents tbody {
            display: block;
            max-height: 300px;
            overflow-y: auto;
        }
        #liveRecords thead, #liveRecords tbody tr,
        #secEvents thead, #secEvents tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        .chart-container {
            height: 280px;
        }
    </style>
    {% endblock head %}
    
{% block body %}
  
<div class="page-wrapper with-navbar">
    <nav class="navbar p-4">
        <div class="navbar-content">
            <a href="#" class="navbar-brand">
                <i class="fas fa-chart-line me-2"></i>
                Live Admin Dashboard
            </a>
        </div>
        <div class="navbar-content">
            <div class="d-flex align-items-center">
                <span class="badge text-bg-success me-2 fs-4" id="ws-status">Connecting...</span>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <!-- KPI Cards -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4">
            <div class="col">
                <div class="card h-full p-3 kpi-card">
                    <div class="kpi-label">Avg. Response Time</div>
                    <div class="kpi-value" id="avg-latency">0 ms</div>
                    <div class="kpi-trend" id="latency-trend"></div>
                </div>
            </div>
            <div class="col">
                <div class="card h-full p-3 kpi-card">
                    <div class="kpi-label">Total Requests</div>
                    <div class="kpi-value" id="total-requests">0</div>
                    <div class="kpi-trend" id="requests-trend"></div>
                </div>
            </div>
            <div class="col">
                <div class="card h-full p-3 kpi-card">
                    <div class="kpi-label">Error Rate (4xx/5xx)</div>
                    <div class="kpi-value" id="error-rate">0%</div>
                    <div class="kpi-trend" id="error-trend"></div>
                </div>
            </div>
             <div class="col">
                <div class="card h-full p-3 kpi-card">
                    <div class="kpi-label">Requests per Second</div>
                    <div class="kpi-value" id="current-rps">0</div>
                    <div class="kpi-trend" id="rps-trend"></div>
                </div>
            </div>
        </div>

        <!-- Main Charts -->
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="card h-full">
                    <div class="p-4">
                        <h2 class="card-title">Requests Per Second (last 60s)</h2>
                    </div>
                    <div class="chart-container px-4 pb-4">
                        <canvas id="rpsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-full">
                    <div class="p-4">
                        <h2 class="card-title">Request Status</h2>
                    </div>
                    <div class="chart-container px-4 pb-4">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Live Data Tables -->
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="card h-full">
                    <div class="p-4">
                        <h2 class="card-title">Live Traffic Feed</h2>
                    </div>
                    <div class="table-responsive px-4 pb-4">
                        <table class="table table-hover" id="liveRecords">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>IP</th>
                                    <th>Country</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-full">
                    <div class="p-4">
                        <h2 class="card-title">Recent Security Events</h2>
                    </div>
                    <div class="table-responsive px-4 pb-4">
                        <table class="table table-hover" id="secEvents">
                            <thead>
                                <tr>
                                    <th>Event</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
const wsProtocol = (location.protocol === 'https:') ? 'wss' : 'ws';
const metricsWS = new WebSocket(`${wsProtocol}://${location.host}/ws/metrics/`);
const securityWS = new WebSocket(`${wsProtocol}://${location.host}/ws/security/`);
const recordsWS = new WebSocket(`${wsProtocol}://${location.host}/ws/records/`);
const wsStatus = document.getElementById('ws-status');

// Data buffers and previous state for trends
const latencies = [];
const statusCounts = { "2xx":0, "3xx":0, "4xx":0, "5xx":0 };
const rpsBuckets = {};
let prevMetrics = { latency: 0, requests: 0, errorRate: 0, rps: 0 };

// Chart.js global settings
Chart.defaults.color = '#6c757d';
Chart.defaults.borderColor = '#dee2e6';
Chart.defaults.plugins.legend.display = false;

// Charts
const statusChart = new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
        labels: ['Success (2xx)', 'Redirects (3xx)', 'Client Errors (4xx)', 'Server Errors (5xx)'],
        datasets: [{ data: [0,0,0,0], backgroundColor: ['#198754', '#ffc107', '#fd7e14', '#dc3545'], borderWidth: 0 }]
    },
    options: { animation: false, responsive: true, maintainAspectRatio: false }
});

const rpsLabels = Array.from({length: 60}, (_, i) => i - 59).map(n => `${n}s`);
const rpsData = Array(60).fill(0);
const rpsChart = new Chart(document.getElementById('rpsChart'), {
    type: 'line',
    data: {
        labels: rpsLabels,
        datasets: [{ label: 'RPS', data: rpsData, borderColor: 'rgba(78, 115, 223, 1)', backgroundColor: 'rgba(78, 115, 223, 0.1)', fill: true, tension: 0.4, pointRadius: 0 }]
    },
    options: {
        animation: false, responsive: true, maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, grid: { drawBorder: false } }, x: { grid: { display: false } } }
    }
});

function updateStatusDisplay(open){
    wsStatus.textContent = open ? 'Live' : 'Disconnected';
    wsStatus.classList.toggle('text-bg-success', open);
    wsStatus.classList.toggle('text-bg-danger', !open);
}

function updateTrend(elementId, currentValue, previousValue, higherIsBetter = true) {
    const trendEl = document.getElementById(elementId);
    if (previousValue === 0 && currentValue === 0) { // Avoid division by zero and unnecessary updates
        trendEl.innerHTML = '';
        return;
    }
    
    const percentChange = (previousValue === 0) ? 100 : ((currentValue - previousValue) / previousValue) * 100;
    const isPositive = percentChange >= 0;
    let icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
    let colorClass = '';

    if (higherIsBetter) {
        colorClass = isPositive ? 'text-success' : 'text-danger';
    } else {
        colorClass = isPositive ? 'text-danger' : 'text-success';
    }

    trendEl.className = `kpi-trend ${colorClass}`;
    trendEl.innerHTML = `<i class="fas ${icon}"></i> ${Math.abs(percentChange).toFixed(1)}%`;
}

function tickRPS(){
    const now = Math.floor(Date.now() / 1000);
    const cutoff = now - 60;
    for (const ts in rpsBuckets) {
        if (ts < cutoff) delete rpsBuckets[ts];
    }
    for (let i = 0; i < 60; i++) {
        const t = now - (59 - i);
        rpsData[i] = rpsBuckets[t] || 0;
    }
    document.getElementById('current-rps').textContent = rpsData[59] || 0;
    rpsChart.update('none');
}

// Main update loop for trends
setInterval(() => {
    const currentRps = rpsData[59] || 0;
    updateTrend('rps-trend', currentRps, prevMetrics.rps, true);
    prevMetrics.rps = currentRps;

    const totalRequests = parseInt(document.getElementById('total-requests').textContent, 10);
    updateTrend('requests-trend', totalRequests, prevMetrics.requests, true);
    prevMetrics.requests = totalRequests;

    const avgLatency = parseInt(document.getElementById('avg-latency').textContent, 10);
    updateTrend('latency-trend', avgLatency, prevMetrics.latency, false);
    prevMetrics.latency = avgLatency;

    const errorRate = parseFloat(document.getElementById('error-rate').textContent);
    updateTrend('error-trend', errorRate, prevMetrics.errorRate, false);
    prevMetrics.errorRate = errorRate;

}, 3000); // Update trends every 3 seconds for smoother display

setInterval(tickRPS, 1000);

metricsWS.onopen = () => updateStatusDisplay(true);
metricsWS.onclose = () => updateStatusDisplay(false);
metricsWS.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    const ts = Math.floor(msg.ts);

    // Latency KPI
    latencies.push(msg.latency_ms);
    if (latencies.length > 100) latencies.shift();
    const avgLatency = latencies.length > 0 ? latencies.reduce((a, b) => a + b, 0) / latencies.length : 0;
    document.getElementById('avg-latency').textContent = `${Math.round(avgLatency)} ms`;

    // Status Chart & KPIs
    if (statusCounts[msg.status_bucket] !== undefined) {
        statusCounts[msg.status_bucket]++;
        statusChart.data.datasets[0].data = [statusCounts["2xx"], statusCounts["3xx"], statusCounts["4xx"], statusCounts["5xx"]];
        statusChart.update('none');

        const total = Object.values(statusCounts).reduce((a, b) => a + b, 0);
        document.getElementById('total-requests').textContent = total;
        const errorCount = statusCounts["4xx"] + statusCounts["5xx"];
        const errorRate = total > 0 ? ((errorCount / total) * 100).toFixed(1) : 0;
        document.getElementById('error-rate').textContent = `${errorRate}%`;
    }
    
    // RPS data
    rpsBuckets[ts] = (rpsBuckets[ts] || 0) + 1;
};

const secBody = document.getElementById('secEvents').querySelector('tbody');
securityWS.onmessage = (e) => {
    const s = JSON.parse(e.data);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.note}</td><td><small>${s.ip || '-'} | ${s.path}</small></td>`;
    secBody.prepend(tr);
    if (secBody.children.length > 20) secBody.lastChild.remove();
};

const recordsBody = document.getElementById('liveRecords').querySelector('tbody');
recordsWS.onmessage = (e) => {
    const r = JSON.parse(e.data);
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${new Date().toLocaleTimeString()}</td>
        <td>${r.ip_address || '-'}</td>
        <td>${r.country || '-'}</td>
        <td>${r.path ? r.path.slice(0, 30) + (r.path.length > 30 ? '...' : '') : '-'}</td>
    `;
    recordsBody.prepend(tr);
    if (recordsBody.children.length > 50) recordsBody.lastChild.remove();
};

})();
</script>
{% endblock body %}
