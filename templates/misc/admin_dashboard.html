<!-- templates/yourapp/admin_dashboard.html -->
{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .card { padding: 16px; border: 1px solid #ddd; border-radius: 14px; box-shadow: 0 6px 14px rgba(0,0,0,.05); }
    .events { max-height: 320px; overflow: auto; font-size: 14px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; margin-left:8px; font-size:12px; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 8px; text-align: left; }
    th { background: #f9f9f9; position: sticky; top: 0; }
    tbody { max-height: 240px; overflow-y: auto; display: block; }
    tr { display: table; width: 100%; table-layout: fixed; }
  </style>
</head>
<body>
  <h2>Live Admin Dashboard <span class="pill" id="ws-status">connecting…</span></h2>

  <div class="grid">
    <div class="card">
      <h3>Latency (ms) – last 60s</h3>
      <canvas id="latencyChart"></canvas>
    </div>
    <div class="card">
      <h3>Status Buckets (rolling)</h3>
      <canvas id="statusChart"></canvas>
    </div>
    <div class="card">
      <h3>Requests/sec (approx – last 60s)</h3>
      <canvas id="rpsChart"></canvas>
    </div>
    <div class="card">
      <h3>Security Events (live)</h3>
      <div class="events" id="secEvents"></div>
    </div>
    <div class="card" style="grid-column: span 2;">
      <h3>Live Records</h3>
      <div class="events">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>IP</th>
              <th>Country</th>
              <th>City</th>
              <th>Path</th>
              <th>Referrer</th>
              <th>User Agent</th>
              <th>Hits</th>
            </tr>
          </thead>
          <tbody id="liveRecords"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  const wsProtocol = (location.protocol === 'https:') ? 'wss' : 'ws';
  const metricsWS = new WebSocket(`${wsProtocol}://${location.host}/ws/metrics/`);
  const securityWS = new WebSocket(`${wsProtocol}://${location.host}/ws/security/`);
  const recordsWS = new WebSocket(`${wsProtocol}://${location.host}/ws/records/`);
  const wsStatus = document.getElementById('ws-status');

  // Data buffers
  const latencies = [];
  const latencyLabels = [];
  const statusCounts = { "2xx":0, "3xx":0, "4xx":0, "5xx":0 };
  const rpsBuckets = {}; // ts -> count

  // Charts
  const latencyChart = new Chart(document.getElementById('latencyChart'), {
    type: 'line',
    data: { labels: latencyLabels, datasets: [{ label: 'Latency (ms)', data: latencies }] },
    options: { animation:false, scales:{ y:{ beginAtZero:true } } }
  });

  const statusChart = new Chart(document.getElementById('statusChart'), {
    type: 'bar',
    data: { labels: ['2xx','3xx','4xx','5xx'], datasets: [{ label: 'Count', data: [0,0,0,0] }] },
    options: { animation:false, scales:{ y:{ beginAtZero:true } } }
  });

  const rpsLabels = Array.from({length:60}, (_,i)=>i-59).map(n=>`${n}s`);
  const rpsData = Array(60).fill(0);
  const rpsChart = new Chart(document.getElementById('rpsChart'), {
    type: 'line',
    data: { labels: rpsLabels, datasets: [{ label: 'RPS', data: rpsData }] },
    options: { animation:false, scales:{ y:{ beginAtZero:true } } }
  });

  function updateStatusDisplay(sock, open){
    wsStatus.textContent = open ? 'live' : 'disconnected';
    wsStatus.style.background = open ? '#d1fae5' : '#fee2e2';
  }

  function tickRPS(nowTs){
    const cutoff = nowTs - 60;
    for (const ts in rpsBuckets){
      if (ts < cutoff) delete rpsBuckets[ts];
    }
    const now = Math.floor(Date.now()/1000);
    for (let i=0;i<60;i++){
      const t = now - (59 - i);
      rpsData[i] = rpsBuckets[t] || 0;
    }
    rpsChart.update('none');
  }

  metricsWS.onopen = () => updateStatusDisplay(metricsWS, true);
  metricsWS.onclose = () => updateStatusDisplay(metricsWS, false);
  metricsWS.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    const ts = msg.ts; // seconds
    const timeLabel = new Date(ts*1000).toLocaleTimeString();
    latencyLabels.push(timeLabel);
    latencies.push(msg.latency_ms);
    if (latencyLabels.length > 60) { latencyLabels.shift(); latencies.shift(); }
    latencyChart.update('none');

    if (statusCounts[msg.status_bucket] !== undefined) {
      statusCounts[msg.status_bucket] += 1;
      statusChart.data.datasets[0].data = [
        statusCounts["2xx"], statusCounts["3xx"], statusCounts["4xx"], statusCounts["5xx"]
      ];
      statusChart.update('none');
    }

    rpsBuckets[ts] = (rpsBuckets[ts] || 0) + 1;
    tickRPS(ts);
  };

  const secBox = document.getElementById('secEvents');
  securityWS.onmessage = (e) => {
    const s = JSON.parse(e.data);
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${s.note} | ${s.ip || '-'} ${s.method} ${s.path}`;
    secBox.prepend(line);
  };

  // Live Records
  const recordsBody = document.getElementById('liveRecords');
  recordsWS.onmessage = (e) => {
    const r = JSON.parse(e.data);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date().toLocaleTimeString()}</td>
      <td>${r.ip_address || '-'}</td>
      <td>${r.country || '-'}</td>
      <td>${r.city || '-'}</td>
      <td>${r.path || '-'}</td>
      <td>${r.referrer || '-'}</td>
      <td>${r.user_agent ? r.user_agent.slice(0,40) + '…' : '-'}</td>
      <td>${r.hit_count || 1}</td>
    `;
    recordsBody.prepend(tr);
    if (recordsBody.childNodes.length > 100) {
      recordsBody.removeChild(recordsBody.lastChild);
    }
  };

})();
</script>
</body>
</html>
