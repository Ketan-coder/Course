{% extends "base.html" %}
{% load static %}

{% block head %}
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <style>
        /* FIX for Quiz Modal Scrolling & Google Forms UI */
        #quiz-modal .modal-content {
            height: auto;
            display: flex;
            flex-direction: column;
        }
        #quiz-modal .modal-body {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* Google Forms Inspired Question Card */
        .question-card {
            background-color: var(--hm-content-bg-color);
            border: 1px solid var(--hm-border-color);
            border-radius: var(--hm-border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s ease;
            position: relative;
        }
        .question-card:focus-within {
            border-color: var(--hm-primary-color);
            box-shadow: 0 0 0 3px rgba(var(--hm-primary-rgb), 0.2);
        }
        .question-options-container .input-group {
            margin-bottom: 0.5rem;
        }
        .question-footer {
            border-top: 1px solid var(--hm-border-color);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .quiz-title-card {
             background-color: var(--hm-content-bg-color);
             border: 1px solid var(--hm-border-color);
             border-top: 8px solid var(--hm-primary-color);
             border-radius: var(--hm-border-radius-lg);
        }
    </style>
{% endblock head %}
    

{% block body %}
<div class="container-fluid content-wrapper">
    <div class="text-start my-4 ps-3">
        <h1 class="font-weight-bold display-3">{% if course %}Edit Course{% else %}Create a New Course{% endif %}</h1>
        <p class="text-muted font-size-18">Follow the steps to build and publish your course.</p>
    </div>

    <div class="row g-4 container-fluid">
        <!-- LEFT: Stepper -->
        <div class="col-lg-3 mb-2">
            {% include 'course/components/accordian_sidebar.html' with step=step course=course %}
        </div>

        <!-- RIGHT: Main Content -->
        <div class="col-lg-9">
            <main>
                <div class="card p-4 p-lg-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="text-start">
                            <h1 class="font-weight-bold">Step 4: Quizzes & Articles</h1>
                            <p class="text-muted font-size-18">Add supplementary materials to enrich your course.</p>
                        </div>
                    </div>
                    <hr>

                    <!-- Sections Container -->
                    <div id="section-container" class="d-flex flex-column gap-3">
                        {% for section in course.sections.all %}
                        <div class="card section-card" data-section-id="{{ section.id }}">
                            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                                <h5 class="mb-0 font-weight-bold">{{ section.title }}</h5>
                            </div>
                            <div class="p-3">
                                <!-- Quizzes List -->
                                <h6 class="font-weight-bold"><i class="ph ph-question me-2"></i>Quizzes</h6>
                                <ul class="list-group list-group-flush mb-3">
                                    {% for quiz in section.quizzes.all %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                        <span><i class="ph ph-radio-button me-2"></i>{{ quiz.title }}</span>
                                        <div>
                                            <button class="btn btn-sm edit-quiz-btn" type="button" data-bs-toggle="modal" data-bs-target="#quiz-modal" data-quiz-id="{{ quiz.id }}">Edit</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteQuiz({{ quiz.id }})">Delete</button>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>

                                <!-- Articles List -->
                                <h6 class="font-weight-bold mt-3"><i class="ph ph-file-text me-2"></i>Article</h6>
                                <ul class="list-group list-group-flush mb-2">
                                    {% if section.article %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                        <span><i class="ph ph-newspaper me-2"></i>{{ section.article.title }}</span>
                                        <div>
                                            <button class="btn btn-sm edit-article-btn" type="button" data-bs-toggle="modal" data-bs-target="#article-modal" data-article-id="{{ section.article.id }}">Edit</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteArticle({{ section.article.id }})">Delete</button>
                                        </div>
                                    </li>
                                    {% endif %}
                                </ul>
                                
                                <!-- Add Buttons -->
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#quiz-modal" data-section-id="{{ section.id }}">
                                        <i class="ph ph-plus"></i> Add Quiz
                                    </button>
                                    {% if not section.article %}
                                    <button class="btn btn-outline-warning btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#article-modal" data-section-id="{{ section.id }}">
                                        <i class="ph ph-plus"></i> Add Article
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="text-end pt-4">
                        <a href="{% if course %}{% url 'course_create_step_five' course_id=course.id %}{% else %}{% url 'course_create_step_five' %} {% endif %}" class="btn btn-primary btn-lg">
                            Next: Finalize & Publish <i class="ph ph-arrow-right ms-2"></i>
                        </a>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>


<!-- Quiz Modal -->
<div class="modal" id="quiz-modal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content">
            <form id="quiz-form" onsubmit="saveQuiz(event)">
                {% csrf_token %}
                <input type="hidden" name="quiz_id" id="quiz-id-input">
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="hidden" name="section_id" id="quiz-section-id-input">

                <div class="modal-header">
                    <h5 class="modal-title" id="quiz-modal-title">Quiz Builder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <div class="card p-4 mb-4 quiz-title-card">
                        <smart-input type="text" name="title" label="Quiz Title" id="quiz-title-input" required></smart-input>
                    </div>
                    <div id="questions-wrapper" class="mb-4"></div>
                    <button type="button" class="btn btn-primary" onclick="addQuestion()">
                        <i class="ph ph-plus-circle me-2"></i>Add Question
                    </button>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Quiz</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Article Modal -->
<div class="modal" id="article-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <form id="article-form" onsubmit="saveArticle(event)">
                {% csrf_token %}
                <input type="hidden" name="article_id" id="article-id-input">
                <input type="hidden" name="course_id" value="{{ course.id }}">
                <input type="hidden" name="section_id" id="article-section-id-input">
                <div class="modal-header">
                    <h5 class="modal-title" id="article-modal-title">Article Editor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="form-group mb-3">
                        <smart-input type="text" name="title" label="Article Title" id="article-title-input" required></smart-input>
                    </div>
                    <div class="form-group mb-3">
                        <smart-quill id="article-content-quill" name="content" label="Article Content"></smart-quill>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Article</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock body %}

{% block script %}
<!-- Quill JS -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const csrfToken = '{{ csrf_token }}';

    // --- MODAL HANDLING ---
    const quizModalEl = document.getElementById('quiz-modal');
    const articleModalEl = document.getElementById('article-modal');

    quizModalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const form = document.getElementById('quiz-form');
        form.reset();
        document.getElementById('questions-wrapper').innerHTML = '';

        const quizId = button.getAttribute('data-quiz-id');
        const sectionId = button.getAttribute('data-section-id');
        document.getElementById('quiz-section-id-input').value = sectionId;
        
        if (quizId) {
            document.getElementById('quiz-modal-title').textContent = 'Edit Quiz';
            document.getElementById('quiz-id-input').value = quizId;
            fetch(`{% url 'get_quiz_details' 999 %}`.replace('999', quizId))
                .then(res => res.json())
                .then(data => {
                    document.getElementById('quiz-title-input').value = data.title;
                    if (data.questions) {
                        Object.values(data.questions).forEach(q => addQuestion(q));
                    }
                });
        } else {
            document.getElementById('quiz-modal-title').textContent = 'Add New Quiz';
            document.getElementById('quiz-id-input').value = '';
            addQuestion();
        }
    });

    articleModalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        document.getElementById('article-form').reset();
        const articleId = button.getAttribute('data-article-id');
        const sectionId = button.getAttribute('data-section-id');
        document.getElementById('article-section-id-input').value = sectionId;

        if (articleId) {
            document.getElementById('article-modal-title').textContent = 'Edit Article';
            document.getElementById('article-id-input').value = articleId;
            fetch(`{% url 'get_article_details' 999 %}`.replace('999', articleId))
                .then(res => res.json())
                .then(data => {
                    document.getElementById('article-title-input').value = data.title;
                    document.querySelector('#article-content-quill').editor.root.innerHTML = data.content;
                });
        } else {
            document.getElementById('article-modal-title').textContent = 'Add New Article';
            document.getElementById('article-id-input').value = '';
            document.querySelector('#article-content-quill').editor.root.innerHTML = '';
        }
    });
});

// --- QUIZ BUILDER ---
let questionCount = 0;
function addQuestion(data = {}) {
    const wrapper = document.getElementById('questions-wrapper');
    const id = `q_${questionCount++}`;
    const questionData = data || {};
    
    const questionCard = document.createElement('div');
    questionCard.className = 'question-card';
    questionCard.id = id;
    
    const questionType = questionData.type || 'SINGLE_SELECT';
    
    // **FIX IS HERE:** Normalize the 'answer' field to always be an array before joining.
    // The answer can be a string like "b" or "a,b,c".
    const answerArray = questionData.answer ? String(questionData.answer).split(',') : [];

    questionCard.innerHTML = `
        <div class="row g-3">
            <div class="col-md-8">
                <smart-input type="text" name="${id}_question" placeholder="Question" label="Question Text" value="${questionData.question || ''}" required></smart-input>
            </div>
            <div class="col-md-4">
                <label for="${id}_type" class="form-label">Question Type</label>
                <select name="${id}_type" class="form-select" onchange="updateQuestionUI('${id}', this.value)">
                    <option value="SINGLE_SELECT" ${questionType === 'SINGLE_SELECT' ? 'selected' : ''}>Multiple choice</option>
                    <option value="MULTIPLE_SELECT" ${questionType === 'MULTIPLE_SELECT' ? 'selected' : ''}>Checkboxes</option>
                    <option value="TEXT" ${questionType === 'TEXT' ? 'selected' : ''}>Short answer</option>
                </select>
            </div>
        </div>
        <div class="mt-3" id="options-container-${id}"></div>
        <div class="question-footer d-flex justify-content-between align-items-center">
             <smart-input type="text" name="${id}_answer" label="Answer Key" placeholder="Enter correct answer(s)..." value="${answerArray.join(',')}" required></smart-input>
             <div class="d-flex align-items-center">
                <smart-input type="number" name="${id}_score" label="Points" value="${questionData.score_on_completion || 5}" min="0"></smart-input>
                <button type="button" class="btn btn-sm text-muted ms-3" onclick="removeQuestion('${id}')"><i class="ph ph-trash"></i></button>
             </div>
        </div>
    `;
    wrapper.appendChild(questionCard);
    updateQuestionUI(id, questionType, questionData.options);
}

function updateQuestionUI(id, type, options = []) {
    const container = document.getElementById(`options-container-${id}`);
    container.innerHTML = ''; // Clear previous options
    
    if (type === 'SINGLE_SELECT' || type === 'MULTIPLE_SELECT') {
        const optionType = type === 'SINGLE_SELECT' ? 'radio' : 'checkbox';
        (options || []).forEach((opt, index) => {
            const optionText = opt.text || opt || '';
            container.innerHTML += `
                <div class="input-group mb-2">
                    <span class="input-group-text"><i class="ph ph-${optionType === 'radio' ? 'radio-button' : 'check-square'}"></i></span>
                    <input type="text" class="form-control" name="${id}_option_${index}" value="${optionText}" placeholder="Option ${index + 1}">
                    <button type="button" class="btn btn-outline-secondary" onclick="this.parentElement.remove()">&times;</button>
                </div>
            `;
        });
        container.innerHTML += `<button type="button" class="btn btn-sm btn-link" onclick="addOption('${id}', '${type}')">Add option</button>`;
    } else if (type === 'TEXT') {
        container.innerHTML = `<input type="text" class="form-control" placeholder="Short answer text" disabled>`;
    }
}

function addOption(id, type) {
    const container = document.getElementById(`options-container-${id}`);
    const optionType = type === 'SINGLE_SELECT' ? 'radio' : 'checkbox';
    const optionIndex = container.querySelectorAll('.input-group').length;
    const newOption = document.createElement('div');
    newOption.className = 'input-group mb-2';
    newOption.innerHTML = `
        <span class="input-group-text"><i class="ph ph-${optionType === 'radio' ? 'radio-button' : 'check-square'}"></i></span>
        <input type="text" class="form-control" name="${id}_option_${optionIndex}" placeholder="Option ${optionIndex + 1}">
        <button type="button" class="btn btn-outline-secondary" onclick="this.parentElement.remove()">&times;</button>
    `;
    // Insert before the "Add option" button
    container.insertBefore(newOption, container.lastChild);
}

function removeQuestion(id) {
    document.getElementById(id)?.remove();
}

// --- FORM SUBMISSION & DELETE ---
function saveQuiz(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    const questions = {};
    document.querySelectorAll('.question-card').forEach((q, index) => {
        const id = q.id;
        const options = Array.from(q.querySelectorAll(`[name^="${id}_option_"]`)).map(opt => ({ text: opt.value }));
        questions[index + 1] = {
            id: index + 1,
            question: formData.get(`${id}_question`),
            type: formData.get(`${id}_type`),
            answer: formData.get(`${id}_answer`),
            options: options,
            score_on_completion: formData.get(`${id}_score`)
        };
        // Clean up formData
        formData.delete(`${id}_question`);
        formData.delete(`${id}_type`);
        formData.delete(`${id}_answer`);
        formData.delete(`${id}_score`);
        q.querySelectorAll(`[name^="${id}_option_"]`).forEach(opt => formData.delete(opt.name));
    });
    formData.append('questions_json', JSON.stringify(questions));

    fetch("{% url 'create_quiz' %}", { method: 'POST', body: formData })
        .then(res => res.json()).then(data => {
            if (data.success) location.reload(); else alert('Error saving quiz.');
        });
}

function saveArticle(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    fetch("{% url 'create_article' %}", { method: 'POST', body: formData })
        .then(res => res.json()).then(data => {
            if (data.success) location.reload(); else alert('Error saving article.');
        });
}

function deleteQuiz(quizId) {
    if (!confirm('Are you sure?')) return;
    fetch(`{% url 'delete_quiz' 999 %}`.replace('999', quizId), {
        method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(res => res.json()).then(data => {
        if (data.success) location.reload(); else alert('Error deleting quiz.');
    });
}

function deleteArticle(articleId) {
    if (!confirm('Are you sure?')) return;
    fetch(`{% url 'delete_article' 999 %}`.replace('999', articleId), {
        method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(res => res.json()).then(data => {
        if (data.success) location.reload(); else alert('Error deleting article.');
    });
}
</script>

{% endblock script %}
