{% extends 'base.html' %}

{% block body %}
<div class="container mt-4">
    <h2 class="mb-4">{% if course %}Edit Course{% else %}Create Course{% endif %}</h2>

    <div class="d-flex gap-2 mb-3">
        <p class="text-muted">Start with these before adding Course: </p>
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvas-add-tag">Add Tag</button>
        <button type="button" class="btn btn-outline-success" data-bs-toggle="offcanvas" data-bs-target="#offcanvas-add-faq">Add FAQ</button>
        <button type="button" class="btn btn-outline-warning" data-bs-toggle="offcanvas" data-bs-target="#offcanvas-add-section">Add Section</button>
        <a href="{% url 'create_quiz' %}" class="btn btn-outline-info">Create Quiz</a>
        <a href="{% url 'create_article' %}" class="btn btn-outline-info">Create Article</a>
    </div>

    <div>
        <p class="text-muted">You can add Tags, FAQs, Sections, Articles and Lessons to your course using the buttons above.</p>
        <p class="text-muted">Make sure to save your course after adding these elements.</p>
        <blockquote class="blockquote">
            <p class="mb-0">Note: Quiz are not editable for now!</p>
        </blockquote>
    </div>

    <!-- Offcanvas: Add Tag -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvas-add-tag">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Add Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <form hx-post="{% url 'create_tag' %}" hx-target="#tag-select" hx-swap="outerHTML" id="tag-form">
            {% csrf_token %}
            <input type="hidden" id="tag-id" name="id"> <!-- used for edit -->
            <div class="mb-3">
                <label for="tag-name" class="form-label">Name</label>
                <input type="text" class="form-control" name="name" id="tag-name" required>
            </div>
            {% comment %} <button type="submit" class="btn btn-primary" id="tag-submit-btn">Save Tag</button> {% endcomment %}
            <div class="d-flex align-items-center gap-3 mt-3">
                <button type="submit" class="btn btn-warning" id="tag-submit-btn">Save Tag</button>
                <div class="spinner-border text-primary d-none" id="tag-spinner" role="status">
                    <span class="visually-hidden">Saving...</span>
                </div>
            </div>
        </form>
        <div id="tag-select"></div>
      </div>
    </div>

    <!-- Offcanvas: Add FAQ -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvas-add-faq">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Add FAQ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <form hx-post="{% url 'create_faq' %}" hx-target="#faq-select" hx-swap="outerHTML" id="faq-form">
            {% csrf_token %}
            <input type="hidden" id="faq-id" name="id"> <!-- used for edit -->
            <div class="mb-3">
                <label for="faq-question" class="form-label">Question</label>
                <input type="text" class="form-control" name="question" id="faq-question" required>
            </div>
            <div class="mb-3">
                <label for="faq-answer" class="form-label">Answer</label>
                <textarea class="form-control" name="answer" id="faq-answer" rows="4" required></textarea>
            </div>
            {% comment %} <button type="submit" class="btn btn-success" id="faq-submit-btn">Save FAQ</button> {% endcomment %}
            <div class="d-flex align-items-center gap-3 mt-3">
                <button type="submit" class="btn btn-warning" id="faq-submit-btn">Save FAQ</button>
                <div class="spinner-border text-primary d-none" id="faq-spinner" role="status">
                    <span class="visually-hidden">Saving...</span>
                </div>
            </div>
        </form>
        <div id="faq-select"></div>
      </div>
    </div>

    <!-- Offcanvas: Add Section -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvas-add-section" style="width: 110vh;">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Add Section</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <form hx-post="{% url 'create_section' %}" hx-target="#section-select" hx-swap="outerHTML" id="section-form" hx-indicator=".htmx-indicator">
            {% csrf_token %}
            <input type="hidden" id="section-id" name="id"> <!-- used for edit -->
            <div class="mb-3">
                <label for="section-title" class="form-label">Title</label>
                <input type="text" class="form-control" name="title" id="section-title" required>
            </div>
            <div class="mb-3">
                <label for="section-description" class="form-label">Description</label>
                <textarea class="form-control" name="description" id="section-description" rows="4"></textarea>
            </div>
            <div class="mb-3">
                <label for="section-order" class="form-label">Order</label>
                <input type="number" class="form-control" name="order" id="section-order" value="0">
            </div>
            <div class="mb-3">
                <label for="section-is_open" class="form-label">Is Open?</label>
                <select name="is_open" id="section-is_open" class="form-select">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            
            <div class="mb-3">
                {% comment %} <label for="section-lessons" class="form-label">Lessons</label>
                <select name="lessons" id="section-lessons" class="form-select" multiple>
                    {% for lesson in lessons %}
                        <option value="{{ lesson.id }}">{{ lesson.title }}</option>
                    {% endfor %}
                </select> {% endcomment %}
                <label for="id_lesson" class="form-label">Lesson:</label>
                <input type="text" id="id_lesson_search" class="form-control" placeholder="Search and add Lessons">
                <div id="lesson_search_results" class="list-group mt-2"></div>
                <div id="selected_lesson" class="mt-2">
                    {% for lesson in course.section.lesson.all %}
                    <span class="badge bg-secondary mr-1 selected-lesson m-1" data-lesson-id="{{ lesson.id }}">
                        {{ lesson.name }} | <a href="{% url 'lesson_form' lesson.id %}" class="btn btn-sm btn-outline-light">Edit</a> | <button type="button" class="btn btn-sm btn-outline-light ml-1 p-0 border-0" aria-label="Remove" onclick="removeLesson(this)">&times;</button>
                    </span>
                    <input type="hidden" name="selected_lesson" value="{{ lessson.id }}">
                    {% endfor %}
                </div>
                {% if form.tags.errors %}
                <div class="invalid-feedback d-block">{{ form.tags.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="id_article" class="form-label">Article:</label>
                <input type="text" id="id_article_search" class="form-control" placeholder="Search and select article">
                <div id="article_search_results" class="list-group mt-2"></div>
                <select name="article" id="id_article" class="form-select mt-2">
                    {% if course.section.article %}
                        <option value="{{ course.section.article.id }}" selected>{{ course.section.article.title }}</option>
                    {% endif %}
                </select>
                {% if form.article.errors %}
                <div class="invalid-feedback d-block">{{ form.article.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group mt-2 mb-3">
                <label for="id_prompt" class="form-label">Prompt for Generating Quiz:</label>
                <textarea name="prompt" id="id_prompt" class="form-control" rows="15"></textarea>
            </div>
            {% comment %} <div class="htmx-indicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div> {% endcomment %}
            <script>
            document.getElementById('id_article_search').addEventListener('input', function () {
                const searchTerm = this.value;
                const resultsDiv = document.getElementById('article_search_results');
                if (searchTerm.length > 1) {
                    fetch(`/course/courses/search_articles/?q=${searchTerm}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length === 0) {
                                resultsDiv.innerHTML = '<div class="list-group-item bg-danger text-white">No articles found! It might does not exist or Used by other course</div>';
                                return;
                            }
                            resultsDiv.innerHTML = '';
                            data.forEach(article => {
                                const articleElement = document.createElement('a');
                                articleElement.href = '#';
                                articleElement.classList.add('list-group-item', 'list-group-item-action');
                                articleElement.textContent = article.title;
                                articleElement.dataset.articleId = article.id;
                                articleElement.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    const select = document.getElementById('id_article');
                                    select.innerHTML = `<option value="${article.id}" selected>${article.title}</option>`;
                                    document.getElementById('id_article_search').value = '';
                                    resultsDiv.innerHTML = '';
                                });
                                resultsDiv.appendChild(articleElement);
                            });
                        });
                } else {
                    resultsDiv.innerHTML = '';
                }
            });
            </script>
            {% comment %} <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modal-add-lesson">Add Lesson</button> {% endcomment %}
            <a type="button" class="btn btn-outline-info" href="{% url "lesson_form" %}">Add Lesson</a>
            {% comment %} <button type="submit" class="btn btn-warning" id="section-submit-btn">Save Section</button> {% endcomment %}
            <!-- Submit Button & Spinner -->
            <div class="d-flex align-items-center gap-3 mt-3">
                <button type="submit" class="btn btn-warning" id="section-submit-btn">Save Section</button>
                <div class="spinner-border text-primary d-none" id="section-spinner" role="status">
                    <span class="visually-hidden">Saving...</span>
                </div>
            </div>

        </form>
        <div id="section-select"></div> 
      </div>
    </div>

    <!-- Modal: Add Lesson -->
    <div class="modal fade" id="modal-add-lesson" tabindex="-1" aria-labelledby="modal-add-lesson-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-add-lesson-label">Add Lesson</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="lesson-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="lesson-title" class="form-label">Title</label>
                            <input type="text" class="form-control" name="title" id="lesson-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="lesson-required-score" class="form-label">Required Score</label>
                            <input type="text" class="form-control" name="required-score" id="lesson-required-score" required>
                        </div>
                        <div class="mb-3">
                            <label for="lesson-description" class="form-label">Description</label>
                            <textarea class="form-control" name="description" id="lesson-description" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="lesson-thumbnail" class="form-label">Thumbnail</label>
                            <input type="file" class="form-control" name="thumbnail" id="lesson-thumbnail">
                        </div>
                        <div class="mb-3">
                            <label for="lesson-video" class="form-label">Video File</label>
                            <input type="file" class="form-control" name="video" id="lesson-video">
                        </div>
                        <div class="text-center my-2">
                            <span class="badge bg-secondary">OR</span>
                        </div>
                        <div class="mb-3">
                            <label for="lesson-video-url" class="form-label">Video Url</label>
                            <input type="text" class="form-control" name="video-url" id="lesson-video-url">
                        </div>
                        <div class="mb-3">
                            <label for="lesson-order" class="form-label">Order</label>
                            <input type="number" class="form-control" name="order" id="lesson-order" value="0">
                        </div>

                        <div class="progress mb-2" style="height: 8px;">
                            <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                        </div>

                        <button type="submit" class="btn btn-info">Save Lesson</button>
                    </form>
                    <div id="lesson-select"></div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {# Display non-field errors #}
        {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="form-group">
            <label for="id_title" class="form-label">Title:</label>
            <input type="text" name="title" id="id_title" value="{{ course.title|default:'' }}" class="form-control"
                required>
            {% if form.title.errors %}
            <div class="invalid-feedback d-block">{{ form.title.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_description" class="form-label">Description:</label>
            <textarea name="description" id="id_description" class="form-control">{{ course.description|default:'' }}</textarea>
            {% if form.description.errors %}
            <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_course_type" class="form-label">Course Type:</label>
            <select name="course_type" id="id_course_type" class="form-control">
                <option value="free" {% if course.course_type == 'free' %}selected{% endif %}>Free</option>
                <option value="paid" {% if course.course_type == 'paid' %}selected{% endif %}>Paid</option>
            </select>
            {% if form.course_type.errors %}
            <div class="invalid-feedback d-block">{{ form.course_type.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_course_level" class="form-label">Course Level:</label>
            <select name="course_level" id="id_course_level" class="form-control">
                <option value="beginner" {% if course.course_level == 'beginner' %}selected{% endif %}>Beginner</option>
                <option value="intermediate" {% if course.course_level == 'intermediate' %}selected{% endif %}>Intermediate</option>
                <option value="advanced" {% if course.course_level == 'advanced' %}selected{% endif %}>Advanced</option>
                <option value="all" {% if course.course_level == 'all' %}selected{% endif %}>All</option>
            </select>
            {% if form.course_level.errors %}
            <div class="invalid-feedback d-block">{{ form.course_level.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_language" class="form-label">Language:</label>
            <select name="language" id="id_language" class="form-control">
                {% for lang in languages %}
                <option value="{{ lang.pk }}" {% if course.language == lang %}selected{% endif %}>{{ lang.name }}</option>
                {% endfor %}
            </select>
            {% if form.language.errors %}
            <div class="invalid-feedback d-block">{{ form.language.errors }}</div>
            {% endif %}
        </div>

        {% comment %} <div class="form-group">
            <label for="id_instructor" class="form-label">Instructor:</label>
            <select name="instructor" id="id_instructor" class="form-control">
                {% for inst in instructors %}
                <option value="{{ inst.pk }}" {% if course.instructor == inst %}selected{% endif %}>{{ inst.profile.user.username }}</option>
                {% endfor %}
            </select>
            {% if form.instructor.errors %}
            <div class="invalid-feedback d-block">{{ form.instructor.errors }}</div>
            {% endif %}
        </div> {% endcomment %}

        <div class="form-group">
            <label for="id_thumbnail" class="form-label">Thumbnail:</label>
            <input type="file" name="thumbnail" id="id_thumbnail" class="form-control" onchange="previewImage(event, 'thumbnail-preview')">
            {% if course.thumbnail %}
            <img id="thumbnail-preview" src="{{ course.thumbnail.url }}" alt="Thumbnail Preview" class="img-fluid mt-2" style="max-height: 120px;">
            {% else %}
            <img id="thumbnail-preview" class="img-fluid mt-2" style="max-height: 120px; display:none;">
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_intro_video" class="form-label">Intro Video:</label>
            <input type="file" name="intro_video" id="id_intro_video" class="form-control">
            {% if course.intro_video %}
            <p class="mt-2">Current: <a href="{{ course.intro_video.url }}" target="_blank">{{ course.intro_video.name }}</a></p>
            {% endif %}
            {% if form.intro_video.errors %}
            <div class="invalid-feedback d-block">{{ form.intro_video.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_tags" class="form-label">Tags:</label>
            <input type="text" id="id_tags_search" class="form-control" placeholder="Search and add tags">
            <div id="tags_search_results" class="list-group mt-2"></div>
            <div id="selected_tags" class="mt-2">
                {% for tag in course.tags.all %}
                <span class="badge bg-secondary mr-1 selected-tag" data-tag-id="{{ tag.id }}">
                    {{ tag.name }} | <button type="button" class="btn btn-sm btn-outline-light" onclick="openEditTag('{{ tag.id }}', '{{ tag.name }}')">Edit</button> | <button type="button" class="btn btn-sm btn-outline-light ml-1 p-0 border-0" aria-label="Remove" onclick="removeTag(this)">&times;</button>
                </span>
                <input type="hidden" name="selected_tags" value="{{ tag.id }}">
                {% endfor %}
            </div>
            {% if form.tags.errors %}
            <div class="invalid-feedback d-block">{{ form.tags.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_prerequisites" class="form-label">Prerequisites:</label>
            <textarea name="prerequisites" id="id_prerequisites" class="form-control">{{ course.prerequisites|default:'' }}</textarea>
            {% if form.prerequisites.errors %}
            <div class="invalid-feedback d-block">{{ form.prerequisites.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_circulam" class="form-label">Curriculum:</label>
            <textarea name="circulam" id="id_circulam" class="form-control">{{ course.circulam|default:'' }}</textarea>
            {% if form.circulam.errors %}
            <div class="invalid-feedback d-block">{{ form.circulam.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_faqs" class="form-label">FAQs:</label>
            <input type="text" id="id_faqs_search" class="form-control" placeholder="Search and add FAQs">
            <div id="faqs_search_results" class="list-group mt-2"></div>
            <div id="selected_faqs" class="mt-2">
                 {% for faq in course.faqs.all %}
                <span class="badge bg-secondary mr-1 selected-faq" data-faq-id="{{ faq.id }}">
                    {{ faq.question }} | <button type="button" class="btn btn-sm btn-outline-light" onclick="openEditFAQ('{{ faq.id }}', '{{ faq.question }}', '{{ faq.answer }}')">Edit</button> | <button type="button" class="btn btn-sm btn-outline-light ml-1 p-0 border-0" aria-label="Remove" onclick="removeFaq(this)">&times;</button>
                </span>
                <input type="hidden" name="selected_faqs" value="{{ faq.id }}">
                {% endfor %}
            </div>
            {% if form.faqs.errors %}
            <div class="invalid-feedback d-block">{{ form.faqs.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_price" class="form-label">Price:</label>
            <!-- <input type="number" name="price" id="id_price" value="{{ course.price|default:'0.0' }}" step="0.01"
                class="form-control"> -->
            <div class="input-group mb-3">
              <span class="input-group-text" id="add-on-1">
                {% if course %} 
                    {{course.instructor.profile.currency.symbol}}
                {% else %}
                    {{logined_profile.currency.symbol}}</span>
                {% endif %}
            </span>
              <input type="number" name="price" id="id_price" value="{{ course.price|default:'0.0' }}" step="0.01"
                class="form-control">
            </div>
            {% if form.price.errors %}
            <div class="invalid-feedback d-block">{{ form.price.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_discount_price" class="form-label">Discount Price:</label>
            <!-- <input type="number" name="discount_price" id="id_discount_price"
                value="{{ course.discount_price|default:'0.0' }}" step="0.01" class="form-control"> -->
              <div class="input-group mb-3">
                <span class="input-group-text" id="add-on-1">
                    {% if course %}
                        {{course.instructor.profile.currency.symbol}}
                    {% else %}
                        {{logined_profile.currency.symbol}}</span>
                    {% endif %}
                <input type="number" name="discount_price" id="id_discount_price"
                value="{{ course.discount_price|default:'0.0' }}" step="0.01" class="form-control">
              </div>
            {% if form.discount_price.errors %}
            <div class="invalid-feedback d-block">{{ form.discount_price.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group form-check">
            <input type="checkbox" name="is_published" id="id_is_published" class="form-check-input" {% if course.is_published %}checked{% endif %}>
            <label for="id_is_published" class="form-check-label">Is Published:</label>
            {% if form.is_published.errors %}
            <div class="invalid-feedback d-block">{{ form.is_published.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group form-check">
            <input type="checkbox" name="is_open_to_all" id="id_is_open_to_all" class="form-check-input" {% if course.is_open_to_all %}checked{% endif %}>
            <label for="id_is_open_to_all" class="form-check-label">Is Open to All:</label>
            {% if form.is_open_to_all.errors %}
            <div class="invalid-feedback d-block">{{ form.is_open_to_all.errors }}</div>
            {% endif %}
        </div>

        {# ManyToMany fields - These will require JavaScript for search and selection #}
        <div class="form-group">
            <label for="id_sections" class="form-label">Sections:</label>
            <input type="text" id="id_sections_search" class="form-control" placeholder="Search and add sections">
            <div id="sections_search_results" class="list-group mt-2"></div>
            <div id="selected_sections" class="mt-2">
                {% comment %} {% for section in course.sections.all %}
                <span class="badge bg-secondary mr-1 selected-section" data-section-id="{{ section.id }}">
                    {{ section.title }} | <button type="button" class="btn btn-sm btn-outline-light" onclick="openEditSection('{{ section.id }}', '{{ section.title }}', '{{ section.order }}', '{{ section.is_open }}', '{{ section.lesson.all|safe }}')">Edit</button> | <button type="button" class="btn btn-sm btn-outline-light ml-1 p-0 border-0" aria-label="Remove" onclick="removeSection(this)">&times;</button>
                </span>
                <input type="hidden" name="selected_sections" value="{{ section.id }}">
                {% endfor %} {% endcomment %}
                {% for section in course.sections.all %}
                <span class="badge bg-secondary mr-1 selected-section" data-section-id="{{ section.id }}">
                    {{ section.title }} | 
                    <button type="button" 
                            class="btn btn-sm btn-outline-light" 
                            onclick="openEditSection(
                                '{{ section.id }}', 
                                '{{ section.title }}', 
                                '{{ section.order }}', 
                                '{{ section.is_open }}',
                                '{% for lesson in section.lesson.all %}{{ lesson.id }}{% if not forloop.last %},{% endif %}{% endfor %}',
                                '{% for lesson in section.lesson.all %}{{ lesson.title }}{% if not forloop.last %}|{% endif %}{% endfor %}'
                            )">
                        Edit
                    </button> | 
                    <button type="button" class="btn btn-sm btn-outline-light ml-1 p-0 border-0" aria-label="Remove" onclick="removeSection(this)">
                        &times;
                    </button>
                </span>
                <input type="hidden" name="selected_sections" value="{{ section.id }}">
            {% endfor %}
            </div>
            {% if form.sections.errors %}
            <div class="invalid-feedback d-block">{{ form.sections.errors }}</div>
            {% endif %}
        </div>

        {# Add similar sections for: #}
        {# is_bought_by_users, bookmarked_by_users, completed_by_users, reviews #}
        {# You'll need to add the HTML structure for these and the corresponding JavaScript #}

 <button type="submit" class="btn btn-primary btn-lg mt-3 float-right">{% if course %}Update Course{% else %}Create Course{% endif %}</button>
</form>
</div>
{% endblock body %}

{% block script %}
<script>
    const addSpinnerAndHideBtn = (btnId, spinnerId) => {
        const btn = document.getElementById(btnId);
        const spinner = document.getElementById(spinnerId);

        if (btn && spinner) {
            btn.classList.add("d-none");
            spinner.classList.remove("d-none");
        }
    };

    const removeSpinnerAndShowBtn = (btnId, spinnerId) => {
        const btn = document.getElementById(btnId);
        const spinner = document.getElementById(spinnerId);

        if (btn && spinner) {
            btn.classList.remove("d-none");
            spinner.classList.add("d-none");
        }
    };

    document.addEventListener("htmx:beforeRequest", function (event) {
        addSpinnerAndHideBtn("section-submit-btn", "section-spinner");
        addSpinnerAndHideBtn("faq-submit-btn", "faq-spinner");
        addSpinnerAndHideBtn("tag-submit-btn", "tag-spinner");
    });

    document.addEventListener("htmx:afterRequest", function (event) {
        removeSpinnerAndShowBtn("section-submit-btn", "section-spinner");
        removeSpinnerAndShowBtn("faq-submit-btn", "faq-spinner");
        removeSpinnerAndShowBtn("tag-submit-btn", "tag-spinner");

        // Optional: reset the form after successful creation
        const forms = [
            { formId: "section-form", btnId: "section-submit-btn" },
            { formId: "faq-form", btnId: "faq-submit-btn" },
            { formId: "tag-form", btnId: "tag-submit-btn" },
        ];

        forms.forEach(formData => {
            const form = document.getElementById(formData.formId);
            if (form && event.detail.successful) {
                form.reset();
            }
        });
    });
</script>

<script>
    // JavaScript for tag search (example)
    document.getElementById('id_tags_search').addEventListener('input', function () {
        const searchTerm = this.value;
        const resultsDiv = document.getElementById('tags_search_results');

        if (searchTerm.length > 1) { // Minimum characters to trigger search
            fetch(`/course/courses/search_tags/?q=${searchTerm}`) // Replace with your actual URL
                .then(response => response.json())
                .then(data => {
                    resultsDiv.innerHTML = ''; // Clear previous results
                    data.forEach(tag => {
                        const tagElement = document.createElement('a');
                        tagElement.href = '#';
                        tagElement.classList.add('list-group-item', 'list-group-item-action');
                        tagElement.textContent = tag.name;
                        tagElement.dataset.tagId = tag.id;
                        tagElement.addEventListener('click', function (e) {
                            e.preventDefault();
                            // Add the selected tag to the selected_tags div
                            const selectedTagsDiv = document.getElementById('selected_tags');
                            // Check if tag is already added
                            if (!selectedTagsDiv.querySelector(`span[data-tag-id="${tag.id}"]`)) {
                                const selectedTagElement = document.createElement('span');
                                selectedTagElement.classList.add('badge', 'bg-secondary', 'mr-1', 'selected-tag');
                                selectedTagElement.dataset.tagId = tag.id; selectedTagElement.classList.add('d-inline-flex', 'align-items-center'); // Add flex and align items
                                selectedTagElement.innerHTML = `${tag.name} <button type="button" class="close ml-1" aria-label="Remove" onclick="removeTag(this)">&times;</button>`;

                                // Add a hidden input to send the ID
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'selected_tags'; // Use the same name for all selected tags
                                hiddenInput.value = tag.id;

                                selectedTagsDiv.appendChild(selectedTagElement);
                                selectedTagsDiv.appendChild(hiddenInput);
                            }

                            // Clear the search input and results
                            document.getElementById('id_tags_search').value = '';
                            resultsDiv.innerHTML = '';
                        });
                        resultsDiv.appendChild(tagElement);
                    });
                });
        } else {
            resultsDiv.innerHTML = ''; // Clear results if search term is too short
        }
    });

    function removeTag(button) {
        const selectedTagElement = button.closest('.selected-tag');
        const tagId = selectedTagElement.dataset.tagId;
        selectedTagElement.remove();
        // Remove the corresponding hidden input
        const hiddenInput = document.querySelector(`input[name="selected_tags"][value="${tagId}"]`);
        if (hiddenInput) {
            hiddenInput.remove();
        }
    }

    // JavaScript for FAQ search (example)
    document.getElementById('id_faqs_search').addEventListener('input', function () {
        const searchTerm = this.value;
        const resultsDiv = document.getElementById('faqs_search_results');

        if (searchTerm.length > 1) {
            fetch(`/course/courses/search_faqs/?q=${searchTerm}`) // Replace with your actual URL
                .then(response => response.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    data.forEach(faq => {
                        const faqElement = document.createElement('a');
                        faqElement.href = '#';
                        faqElement.classList.add('list-group-item', 'list-group-item-action');
                        faqElement.textContent = faq.question;
                        faqElement.dataset.faqId = faq.id;
                        faqElement.addEventListener('click', function (e) {
                            e.preventDefault();
                            const selectedFaqsDiv = document.getElementById('selected_faqs');
                            if (!selectedFaqsDiv.querySelector(`span[data-faq-id="${faq.id}"]`)) {
                                const selectedFaqElement = document.createElement('span');
                                selectedFaqElement.classList.add('badge', 'bg-secondary', 'mr-1', 'selected-faq');
                                selectedFaqElement.dataset.faqId = faq.id; selectedFaqElement.classList.add('d-inline-flex', 'align-items-center'); // Add flex and align items
                                selectedFaqElement.innerHTML = `${faq.question} <button type="button" class="close ml-1" aria-label="Remove" onclick="removeFaq(this)">&times;</button>`;

                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'selected_faqs';
                                hiddenInput.value = faq.id;

                                selectedFaqsDiv.appendChild(selectedFaqElement);
                                selectedFaqsDiv.appendChild(hiddenInput);
                            }
                            document.getElementById('id_faqs_search').value = '';
                            resultsDiv.innerHTML = '';
                        });
                        resultsDiv.appendChild(faqElement);
                    });
                });
        } else {
            resultsDiv.innerHTML = '';
        }
    });

    function removeFaq(button) {
        const selectedFaqElement = button.closest('.selected-faq');
        const faqId = selectedFaqElement.dataset.faqId;
        selectedFaqElement.remove();
        const hiddenInput = document.querySelector(`input[name="selected_faqs"][value="${faqId}"]`);
        if (hiddenInput) {
            hiddenInput.remove();
        }
    }

    // JavaScript for Lessson search (example)
    document.getElementById('id_lesson_search').addEventListener('input', function () {
        const searchTerm = this.value;
        const resultsDiv = document.getElementById('lesson_search_results');

        if (searchTerm.length > 1) {
            fetch(`/course/courses/search_lesson/?q=${searchTerm}`) // Replace with your actual URL
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<div class="list-group-item bg-danger text-white">No lessons found! It might does not exist or Used by other course</div>';
                        return;
                    }
                    resultsDiv.innerHTML = '';
                    data.forEach(lesson => {
                        const lessonElement = document.createElement('a');
                        lessonElement.href = '#';
                        lessonElement.classList.add('list-group-item', 'list-group-item-action');
                        lessonElement.textContent = lesson.title;
                        lessonElement.dataset.lessonId = lesson.id;
                        lessonElement.addEventListener('click', function (e) {
                            e.preventDefault();
                            const selectedLessonDiv = document.getElementById('selected_lesson');
                            if (!selectedLessonDiv.querySelector(`span[data-lesson-id="${lesson.id}"]`)) {
                                const selectedLessonElement = document.createElement('span');
                                selectedLessonElement.classList.add('badge', 'bg-secondary', 'mr-1', 'selected-lesson', 'm-1');
                                selectedLessonElement.dataset.lessonId = lesson.id; selectedLessonElement.classList.add('d-inline-flex', 'align-items-center'); // Add flex and align items
                                selectedLessonElement.innerHTML = `${lesson.title} | <a href="${window.location.origin}/course/lesson/add/${lesson.id}/" class="btn btn-sm btn-outline-light">Edit</a> | <button type="button" class="close ml-1" aria-label="Remove" onclick="removeLesson(this)">&times;</button>`;

                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'selected_lesson';
                                hiddenInput.value = lesson.id;

                                selectedLessonDiv.appendChild(selectedLessonElement);
                                selectedLessonDiv.appendChild(hiddenInput);
                            }
                            document.getElementById('id_lesson_search').value = '';
                            resultsDiv.innerHTML = '';
                        });
                        resultsDiv.appendChild(lessonElement);
                    });
                });
        } else {
            resultsDiv.innerHTML = '';
        }
    });

    function removeLesson(button) {
        const selectedLessonElement = button.closest('.selected-lesson');
        const faqId = selectedLessonElement.dataset.faqId;
        selectedLessonElement.remove();
        const hiddenInput = document.querySelector(`input[name="selected_lesson"][value="${faqId}"]`);
        if (hiddenInput) {
            hiddenInput.remove();
        }
    }

    // JavaScript for Section search (example)
    document.getElementById('id_sections_search').addEventListener('input', function () {
        const searchTerm = this.value;
        const resultsDiv = document.getElementById('sections_search_results');

        if (searchTerm.length > 1) {
            fetch(`/course/courses/search_sections/?q=${searchTerm}`) // Replace with your actual URL
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<div class="list-group-item bg-danger text-white">No sections found! It might does not exist or Used by other course</div>';
                        return;
                    }
                    resultsDiv.innerHTML = '';
                    data.forEach(section => {
                        const sectionElement = document.createElement('a');
                        sectionElement.href = '#';
                        sectionElement.classList.add('list-group-item', 'list-group-item-action');
                        sectionElement.textContent = section.title;
                        sectionElement.dataset.sectionId = section.id;
                        sectionElement.addEventListener('click', function (e) {
                            e.preventDefault();
                            const selectedSectionsDiv = document.getElementById('selected_sections');
                            if (!selectedSectionsDiv.querySelector(`span[data-section-id="${section.id}"]`)) {
                                const selectedSectionElement = document.createElement('span');
                                selectedSectionElement.classList.add('badge', 'bg-secondary', 'mr-1', 'selected-section');
                                selectedSectionElement.dataset.sectionId = section.id; selectedSectionElement.classList.add('d-inline-flex', 'align-items-center'); // Add flex and align items
                                selectedSectionElement.innerHTML = `${section.title} <button type="button" class="close ml-1" aria-label="Remove" onclick="removeSection(this)">&times;</button>`;

                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'selected_sections';
                                hiddenInput.value = section.id;

                                selectedSectionsDiv.appendChild(selectedSectionElement);
                                selectedSectionsDiv.appendChild(hiddenInput);
                            }
                            document.getElementById('id_sections_search').value = '';
                            resultsDiv.innerHTML = '';
                        });
                        resultsDiv.appendChild(sectionElement);
                    });
                });
        } else {
            resultsDiv.innerHTML = '';
        }
    });

    function removeSection(button) {
        const selectedSectionElement = button.closest('.selected-section');
        const sectionId = selectedSectionElement.dataset.sectionId;
        selectedSectionElement.remove();
        const hiddenInput = document.querySelector(`input[name="selected_sections"][value="${sectionId}"]`);
        if (hiddenInput) {
            hiddenInput.remove();
        }
    }
    const quillFields = ["description", "prerequisites", "circulam"];
    quillFields.forEach(field => {
        const textArea = document.getElementById(`id_${field}`);
        const parent = textArea.parentNode;
        const wrapper = document.createElement("div");
        wrapper.innerHTML = `<div id="editor_${field}" class="quill-editor">${textArea.value}</div>`;
        parent.insertBefore(wrapper, textArea);
        textArea.style.display = "none";

        const quill = new Quill(`#editor_${field}`, {
            theme: 'snow'
        });
        quill.on('text-change', () => {
            textArea.value = quill.root.innerHTML;
        });
    });

    function previewImage(event, id) {
        const reader = new FileReader();
        reader.onload = function () {
            const output = document.getElementById(id);
            output.src = reader.result;
            output.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    // Upload with progress bar
    document.getElementById('lesson-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "create_lesson" %}', true);
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                document.getElementById('upload-progress-bar').style.width = percentComplete + '%';
            }
        });

        xhr.onload = function () {
            if (xhr.status === 200) {
                document.getElementById('upload-progress-bar').classList.add('bg-success');
                // Reload or update UI here
                console.log('Upload successful', xhr.responseText);
                // Close the modal
                $('#modal-add-lesson').modal('hide');
                // Optionally, you can reset the form
                form.reset();
                document.getElementById('upload-progress-bar').style.width = '0%';
                document.getElementById('upload-progress-bar').classList.remove('bg-success');
                // Optionally, you can update the lesson select dropdown or any other UI element
                const lessonSelect = document.getElementById('lesson-select');
                const newOption = document.createElement('option');
                newOption.value = xhr.responseText;
                newOption.textContent = xhr.responseText;
                lessonSelect.appendChild(newOption);
            } else {
                console.error('Upload failed', xhr.responseText);
            }
        };

        xhr.send(formData);
    });
</script>
<script>
// Function to open the offcanvas for adding/editing tags
function openEditTag(id, name) {
  document.getElementById('tag-id').value = id;
  document.getElementById('tag-name').value = name;

  const form = document.getElementById('tag-form');
  //form.setAttribute('hx-post', `/course/tags/edit/${id}/`); // dynamic edit URL

  document.getElementById('tag-submit-btn').textContent = "Update Tag";

  // Open the offcanvas
  const tagCanvas = new bootstrap.Offcanvas('#offcanvas-add-tag');
  tagCanvas.show();
}

// Function to open the offcanvas for adding/editing fags
function openEditFAQ(id, question, answer) {
    document.getElementById('faq-id').value = id;
    document.getElementById('faq-question').value = question;
    document.getElementById('faq-answer').value = answer;
  
    const form = document.getElementById('faq-form');
  
    document.getElementById('faq-submit-btn').textContent = "Update FAQ";
  
    // Open the offcanvas
    const tagCanvas = new bootstrap.Offcanvas('#offcanvas-add-faq');
    tagCanvas.show();
  }

// Function to open the offcanvas for adding/editing sections
function openEditSection(id, title, order, is_open, lesson_ids, lesson_titles) {
    // Set basic fields
    document.getElementById('section-id').value = id;
    document.getElementById('section-title').value = title;
    document.getElementById('section-order').value = order;
    
    // Set is_open toggle switch
    const isOpenSwitch = document.getElementById('section-is_open');
    isOpenSwitch.checked = (is_open === 'True' || is_open === true);
    
    // Clear previous selected lessons
    const selectedLessonContainer = document.getElementById('selected_lesson');
    selectedLessonContainer.innerHTML = '';
    
    try {
        // Parse lesson IDs and titles if they exist
        if (lesson_ids && lesson_titles) {
            const idsArray = lesson_ids.split(',');
            const titlesArray = lesson_titles.split('|');
            
            idsArray.forEach((id, index) => {
                if (id && titlesArray[index]) {
                    const lessonBadge = document.createElement('span');
                    lessonBadge.className = 'badge bg-secondary mr-1 selected-lesson mb-1 m-1';
                    lessonBadge.setAttribute('data-lesson-id', id.trim());
                    lessonBadge.innerHTML = `
                        ${titlesArray[index].trim()} 
                        | <a href="/course/lesson/${id}" class="btn btn-sm btn-outline-light">Edit</a> |
                        <button type="button" 
                                class="btn btn-sm btn-outline-light ml-1 p-0 border-0" 
                                aria-label="Remove" 
                                onclick="removeLesson(this)">
                            &times;
                        </button>
                    `;
                    
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'selected_lesson';
                    hiddenInput.value = id.trim();
                    
                    selectedLessonContainer.appendChild(lessonBadge);
                    selectedLessonContainer.appendChild(hiddenInput);
                }
            });
        }
    } catch (e) {
        console.error('Error parsing lessons:', e);
    }
  
    // Update button text
    document.getElementById('section-submit-btn').textContent = id ? "Update Section" : "Add Section";
  
    // Open the offcanvas
    const tagCanvas = new bootstrap.Offcanvas('#offcanvas-add-section');
    tagCanvas.show();
}
</script>

{% include "footer.html" %}
{% endblock script %}